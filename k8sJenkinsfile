#!/usr/bin/env groovy
// pipeline {
//     agent {
//         kubernetes {
//             containerTemplate {
//                 name 'helm'
//                 image 'lachlanevenson/k8s-helm:v3.1.1'
//                 ttyEnabled true
//                 command 'cat'
//             }
//         }
//     }

//     stages {
//         stage('Deploy Streaming') {
//             steps {
//                 container('helm') { 
//                     sh "helm version"
//                 } 
//             }
//         }
//     }
// }

// podTemplate(containers: [
//     // containerTemplate(name: 'k8s-helm', image: 'lachlanevenson/k8s-helm:latest'),
//     containerTemplate(name: 'busybox', image: 'busybox'),
//   ]) {

//     node(POD_LABEL) {
//         // stage('Helm slave test') {
//         //     container('k8s-helm') {
//         //         stage('Helm Version') {
//         //             sh 'helm version'
//         //         }
//         //     }
//         // }
//         stage('Busybox') {
//             container('busybox') {
//                 stage('busy box test') {
//                     sh 'echo "Hello Busybox"'
//                 }
//             }
//         }
//     }
// }

// podTemplate {
//     node(POD_LABEL) {
//         stage('Run shell') {
//             sh 'echo hello world'
//         }
//     }
// }

pipeline {
  agent {
    kubernetes {
      yaml '''
        apiVersion: v1
        kind: Pod
        metadata:
          labels:
            some-label: some-label-value
        spec:
          containers:
          - name: maven
            image: maven:alpine
            command:
            - cat
            tty: true
          - name: busybox
            image: busybox
            command:
            - cat
            tty: true
        '''
    }
  }
  stages {
    stage('Run maven') {
      steps {
        container('maven') {
          sh 'mvn -version'
        }
        container('busybox') {
          sh '/bin/busybox'
        }
      }
    }
  }
}